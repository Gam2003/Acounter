<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบนับจำนวน 96 ช่อง</title>
    <style>
        /* --- ส่วนของ CSS (ดีไซน์) --- */
        body {
            font-family: 'Sarabun', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #fcfcfc;
            padding: 20px;
            margin: 0;
        }

        h1 {
            color: #d32f2f;
            margin-bottom: 20px;
            text-align: center;
        }

        /* ปุ่มควบคุมต่างๆ */
        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            width: 100%;
            max-width: 1300px;
            justify-content: space-between;
            flex-wrap: wrap; /* รองรับมือถือให้ปุ่มตกลงมาบรรทัดล่างได้ */
        }

        .total-display {
            font-size: 1.2rem;
            color: #333;
            font-weight: bold;
        }
        
        .total-display span {
            color: #d32f2f;
            font-size: 1.5rem;
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        /* ปุ่ม Reset สีแดง */
        .reset-btn {
            background-color: #ff5252;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s;
        }

        .reset-btn:hover {
            background-color: #d32f2f;
        }

        /* ปุ่ม Undo สีส้ม */
        .undo-btn {
            background-color: #ff9800;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .undo-btn:hover {
            background-color: #f57c00;
        }

        .undo-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Container สำหรับตาราง */
        .grid-wrapper {
            max-width: 100%;
            overflow-x: auto;
            padding-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-radius: 8px;
            background: white;
            padding: 15px;
        }

        /* Grid 4 แถว x 24 คอลัมน์ */
        #counter-grid {
            display: grid;
            grid-template-columns: repeat(24, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 5px;
            min-width: 1300px;
        }

        /* ดีไซน์ของแต่ละช่อง */
        .counter-box {
            height: 60px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid #ffcccb;
            border-radius: 6px;
            cursor: pointer;
            background-color: #fff5f5;
            transition: all 0.1s ease;
            user-select: none;
            flex-direction: column;
        }

        .counter-box:hover {
            transform: translateY(-2px);
            border-color: #ff5252;
            box-shadow: 0 2px 4px rgba(255, 0, 0, 0.2);
            z-index: 10;
        }

        /* เลขกำกับช่อง (1-96) */
        .box-number {
            position: absolute;
            top: 2px;
            left: 5px;
            font-size: 10px;
            opacity: 0.6;
        }

        /* ตัวเลขนับจำนวน */
        .count-value {
            font-size: 18px;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <h1>ระบบนับจำนวน 96 ช่อง (Auto Save + Undo)</h1>

    <div class="controls">
        <div class="total-display">
            ยอดรวมทั้งหมด: <span id="grand-total">0</span> ครั้ง
        </div>
        <div class="button-group">
            <button class="undo-btn" id="undo-btn" disabled>↩ ย้อนกลับ</button>
            <button class="reset-btn" id="reset-btn">รีเซ็ตข้อมูลใหม่ (ล้างค่า)</button>
        </div>
    </div>

    <div class="grid-wrapper">
        <div id="counter-grid">
            </div>
    </div>

    <script>
        /* --- ส่วนของ JavaScript (ระบบทำงาน) --- */
        
        const ROWS = 4;
        const COLS = 24;
        const TOTAL_BOXES = ROWS * COLS;
        const STORAGE_KEY = 'counter_96_data'; 

        const gridContainer = document.getElementById('counter-grid');
        const grandTotalSpan = document.getElementById('grand-total');
        const resetBtn = document.getElementById('reset-btn');
        const undoBtn = document.getElementById('undo-btn');

        // ตัวแปรเก็บประวัติการกด (History Stack)
        let historyStack = [];

        // โหลดข้อมูลเก่าจาก LocalStorage ถ้าไม่มีให้สร้าง Array 0 ใหม่
        let countsData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || new Array(TOTAL_BOXES).fill(0);

        // เก็บ References ของ Element กล่องไว้
        const boxElements = [];

        // --- ฟังก์ชันพื้นฐาน ---

        // ฟังก์ชันบันทึกข้อมูลลงเครื่อง
        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(countsData));
        }

        // ฟังก์ชันเก็บประวัติก่อนที่จะมีการเปลี่ยนแปลงค่า (สำหรับ Undo)
        function saveHistory() {
            // ก๊อปปี้ข้อมูลปัจจุบันเก็บใส่ถุงประวัติ
            // [...countsData] คือการสร้าง Array ใหม่ที่เหมือนเดิม (Shallow Copy)
            historyStack.push([...countsData]);
            
            // จำกัดประวัติไว้แค่ 50 ครั้งล่าสุด (กันเมมโมรี่เต็ม)
            if (historyStack.length > 50) {
                historyStack.shift();
            }
            
            updateUndoButton(); // อัปเดตสถานะปุ่ม
        }

        // ฟังก์ชันคำนวณสีแดง Heatmap
        function getRedColor(count) {
            const baseHue = 0;
            const baseSat = 90;
            let lightness = 98 - (count * 5); 
            if (lightness < 40) lightness = 40;

            const textColor = lightness < 65 ? '#ffffff' : '#5a0000';
            const numOpacity = lightness < 65 ? 0.8 : 0.5;

            return {
                bg: `hsl(${baseHue}, ${baseSat}%, ${lightness}%)`,
                text: textColor,
                numOpacity: numOpacity,
                border: `hsl(${baseHue}, ${baseSat}%, ${lightness - 10}%)`
            };
        }

        // ฟังก์ชันอัปเดตยอดรวม
        function updateGrandTotal() {
            let total = countsData.reduce((a, b) => a + b, 0);
            grandTotalSpan.innerText = total.toLocaleString();
        }

        // ฟังก์ชันเปิด/ปิดปุ่ม Undo
        function updateUndoButton() {
            if (historyStack.length > 0) {
                undoBtn.disabled = false;
                undoBtn.style.opacity = "1";
            } else {
                undoBtn.disabled = true;
                undoBtn.style.opacity = "0.6";
            }
        }

        // ฟังก์ชัน Refresh หน้าจอทั้งหมด (ใช้ตอนโหลดครั้งแรก, Undo หรือ Reset)
        function refreshAllGrid() {
            boxElements.forEach((el, index) => {
                const val = countsData[index];
                el.countSpan.innerText = val;
                
                const colors = getRedColor(val);
                el.box.style.backgroundColor = colors.bg;
                el.box.style.color = colors.text;
                el.box.style.borderColor = colors.border;
                el.numberSpan.style.opacity = colors.numOpacity;
            });
            updateGrandTotal();
            saveData();
        }

        // --- เริ่มต้นสร้างตาราง ---
        for (let i = 0; i < TOTAL_BOXES; i++) {
            const box = document.createElement('div');
            box.classList.add('counter-box');
            
            const boxID = i + 1;
            
            const numberSpan = document.createElement('span');
            numberSpan.classList.add('box-number');
            numberSpan.innerText = boxID;

            const countSpan = document.createElement('span');
            countSpan.classList.add('count-value');
            
            box.appendChild(numberSpan);
            box.appendChild(countSpan);
            
            boxElements.push({ box, countSpan, numberSpan });

            // Event เมื่อคลิกกล่อง
            box.addEventListener('click', () => {
                saveHistory(); // 1. เก็บประวัติก่อนแก้
                
                countsData[i]++; // 2. แก้ไขค่า
                
                // 3. อัปเดตเฉพาะกล่องนี้ (เพื่อประสิทธิภาพที่ดีกว่า refreshAll)
                countSpan.innerText = countsData[i];
                const colors = getRedColor(countsData[i]);
                box.style.backgroundColor = colors.bg;
                box.style.color = colors.text;
                box.style.borderColor = colors.border;
                numberSpan.style.opacity = colors.numOpacity;

                updateGrandTotal(); // 4. อัปเดตยอดรวม
                saveData(); // 5. บันทึก
            });

            gridContainer.appendChild(box);
        }

        // โหลดข้อมูลครั้งแรก
        refreshAllGrid();
        updateUndoButton();

        // --- Event ปุ่ม Undo ---
        undoBtn.addEventListener('click', () => {
            if (historyStack.length > 0) {
                // ดึงข้อมูลชุดล่าสุดออกมาจากประวัติ
                const previousData = historyStack.pop();
                
                // แทนที่ข้อมูลปัจจุบัน
                countsData = previousData;
                
                // วาดหน้าจอใหม่
                refreshAllGrid();
                updateUndoButton();
            }
        });

        // --- Event ปุ่ม Reset ---
        resetBtn.addEventListener('click', () => {
            if (confirm('คุณแน่ใจหรือไม่ว่าจะล้างค่าการนับทั้งหมด?')) {
                saveHistory(); // เก็บประวัติก่อนรีเซ็ต (เผื่อเปลี่ยนใจกด Undo ได้)
                
                countsData = new Array(TOTAL_BOXES).fill(0);
                refreshAllGrid();
            }
        });

    </script>
</body>
</html>
